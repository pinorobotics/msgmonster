#!/usr/bin/env -S java --source 17

import java.util.*;
import java.util.stream.*;
import java.io.*;
import java.nio.file.*;

/**
 * Cross-platform launcher script.
 *
 * Note:
 *
 * Trying to run Java scripts (Single-File Source-Code Programs) with JRE only,
 * results in the following error: "Module jdk.compiler not in boot Layer".
 * Java scripts are compiled on the fly and so, they require JDK to be present in the system.
 * See: https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html#using-source-file-mode-to-launch-single-file-source-code-programs
 *
 * Website: https://github.com/pinorobotics
 *
 * @author aeon_flux <aeon_flux@eclipso.ch>
 */
 class Launcher {

    static final String MAIN_CLASS = "pinorobotics.msgmonster.app.MsgmonsterApp";
    
    /**
     * Parent folder of this script
     */
    static Path BASE_DIR;

    static void fail(String msg) {
        System.err.println(msg);
        System.exit(1);
    }

    public static void main(String... args) throws Exception {
        var javaVersion = 22;
        if (Runtime.version().feature() < javaVersion)
            fail("Java %s is required".formatted(javaVersion));

        BASE_DIR = Paths.get(Launcher.class.getProtectionDomain().getCodeSource().getLocation().toURI())
            .toRealPath()
            .getParent()
            .toAbsolutePath();
        var classpath = BASE_DIR.resolve("libs").toString();
        var argsList = new ArrayList<String>(List.of(
            "java",
            "-p", classpath,
            "--add-modules", "msgmonster"));
        argsList.add(MAIN_CLASS);
        argsList.addAll(Arrays.asList(args));
        System.err.println("Running command: " + argsList);
        // separate further output from application with a newline
        System.err.println();
        System.exit(new ProcessBuilder(argsList).inheritIO().start().waitFor());
    }
 }
